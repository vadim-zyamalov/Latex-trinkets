\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{praeambel}[2025/03/26 My personal preamble]

\RequirePackage{iftex}
\ifpdftex
	\PackageError{praeambel}{pdftex is not supported}{Use XeTeX or LuaTeX instead}
	\@@end
\fi

\RequirePackage{kvoptions}

\DeclareBoolOption{beamer}
\DeclareBoolOption{babel}

\DeclareStringOption[PT Astra Serif]{mainfont}
\DeclareStringOption[PT Astra Sans]{sansfont}
\DeclareStringOption[Cascadia Code]{monofont}
\DeclareStringOption[TeX Gyre Termes Math]{mathfont}

\def\praeambel@language{russian}
\def\praeambel@nativelng{russian}
\DeclareDefaultOption{\edef\praeambel@language{\CurrentOption}}

\ProcessKeyvalOptions*

% --------------------------- %
% Языковые настройки и шрифты %
% --------------------------- %

\ifpraeambel@babel
	\usepackage{fontspec}
	\ifx\praeambel@language\praeambel@nativelng
		\RequirePackage[russian, english]{babel}
	\else
		\RequirePackage[\praeambel@language, russian]{babel}
	\fi
\else
	\RequirePackage{polyglossia}
	\ifx\praeambel@language\praeambel@nativelng
		\setdefaultlanguage{russian}
		\setotherlanguage{english}
	\else
		\setdefaultlanguage{\praeambel@language}
		\setotherlanguage{russian}
	\fi
\fi

\defaultfontfeatures{Ligatures={TeX}}
\setmainfont{\praeambel@mainfont}
\setsansfont{\praeambel@sansfont}
\setmonofont{\praeambel@monofont}

\newfontfamily{\cyrillicfont}{\praeambel@mainfont}
\newfontfamily{\cyrillicfontsf}{\praeambel@sansfont}
\newfontfamily{\cyrillicfonttt}{\praeambel@monofont}

\ifx\praeambel@language\praeambel@nativelng
\else
	\expandafter\newfontfamily\csname\praeambel@language font\endcsname{\praeambel@mainfont}
	\expandafter\newfontfamily\csname\praeambel@language fontsf\endcsname{\praeambel@sansfont}
	\expandafter\newfontfamily\csname\praeambel@language fonttt\endcsname{\praeambel@monofont}
\fi

\RequirePackage{cmap}
\RequirePackage{csquotes}
\RequirePackage{bookmark}
\RequirePackage{parskip}
\RequirePackage{moresize}

% ------------------------------- %
% Математические шрифты и символы %
% ------------------------------- %
\RequirePackage{amsmath}
\RequirePackage{amssymb}

\ifpraeambel@beamer
\else
	% В beamer уже есть свои окружения для теорем
	\RequirePackage{amsthm}
	\RequirePackage{nicefrac}

	\theoremstyle{definition}
	\newtheorem*{theorem}{Теорема}
	\newtheorem{example}{Пример}
\fi

% mathtools что-то делает с горизонтальными фигурными скобками
% https://tex.stackexchange.com/q/552864/283103
\let\normalunderbrace=\underbrace
\RequirePackage{mathtools}
\RequirePackage{unicode-math}
\let\underbrace=\normalunderbrace

\setmathfont{\praeambel@mathfont}
\defaultfontfeatures{Scale=MatchLowercase}
\defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}

% ------------------------------ %
% Геометрия страницы и коробочки %
% ------------------------------ %
\ifpraeambel@beamer
\else
	% Эти настройки не нужны в beamer
	\RequirePackage[left=3cm, right=1.5cm, top=2cm, bottom=2cm]{geometry}
	\RequirePackage{setspace}
	\onehalfspacing

	\setlength{\parindent}{12.5mm}
	\righthyphenmin=2

	\widowpenalty=10000
	\tolerance=1000
\fi

\RequirePackage{adjustbox}
\RequirePackage[most]{tcolorbox}

% ------ %
% Списки %
% ------ %
\ifpraeambel@beamer
\else
	% enumitem конфликтует с beamer
	\RequirePackage{enumitem}
	\AddEnumerateCounter{\Asbuk}{\russian@alph}{Щ}
	\AddEnumerateCounter{\asbuk}{\russian@alph}{щ}
\fi

\providecommand{\tightlist}{%
	\setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% ------ %
% Прочее %
% ------ %
\RequirePackage{xcolor}

\IfFileExists{microtype.sty}{
	\RequirePackage[]{microtype}
	\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}

\ifpraeambel@beamer
\else
	% Подзаголовок на титульном листе
	\RequirePackage{etoolbox}
	\providecommand{\subtitle}[1]{
		\apptocmd{\@title}{\par {\large #1 \par}}{}{}
	}
\fi

% ----------------- %
% Ссылки и закладки %
% ----------------- %
\RequirePackage{bookmark}
\RequirePackage[
	backend=biber,
	bibstyle=gost-authoryear-min,
	citestyle=gost-authoryear,
	movenames=false
]{biblatex}
\RequirePackage{xurl}
\urlstyle{same}

\setcounter{biburllcpenalty}{100}
\setcounter{biburlucpenalty}{200}
\setcounter{biburlnumpenalty}{100}

% ------- %
% Рисунки %
% ------- %
\RequirePackage{graphicx}

% ------------------ %
% Рисование графиков %
% ------------------ %
\RequirePackage{tikz}
\RequirePackage{pgfplots}
\RequirePackage{pgfplotstable}
\RequirePackage{colortbl}

% ------- %
% Таблицы %
% ------- %
\ifpraeambel@beamer
\else
	\RequirePackage{longtable}
\fi
\RequirePackage{booktabs}
\RequirePackage{multicol}
\RequirePackage{multirow}
\RequirePackage{makecell}

\RequirePackage{siunitx}[=v2]
\sisetup{
	detect-all,
	table-number-alignment=center,
	table-figures-integer=2,
	table-figures-decimal=2
}

% -------- %
% Листинги %
% -------- %
\RequirePackage{minted}

% ------------------- %
% Приложения в Beamer %
% ------------------- %
\ifpraeambel@beamer
	\RequirePackage{appendixnumberbeamer}
	\newcommand\makebeamertitle{\frame{\maketitle}}
\fi

\endinput

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{praeambel}[2025/03/26 My personal preamble]

% Код для выделения головы и хвоста разделенного запятыми списка
% Взято здесь (с моими модификациями):
% https://tex.stackexchange.com/a/115848/221857

% Просто пустой макрос-заглушка.
\def\DUMMY{}
% Макрос, принимающий на вход список и вызывающий новый макрос,
% которому передается список, к которому присоединены запятая и заглушка.
\def\spliceList#1{\expandafter\@spliceList #1,\DUMMY}
% Тот самый макрос, который принимает на вход список с запятой и заглушкой и
% производит сравнение с образцом, выделяя первый элемент и все остальные
% вплоть до заглушки (не включительно).
% Если все остальные элементы представляют собой непустой список,
% то передаем его в еще один вспомогательный макрос, отсекающий лишнюю запятую.
\def\@spliceList#1,#2\DUMMY{%
  \def\@listhead{#1}
  % Проверяем список на непустоту.
  \ifx\DUMMY#2\DUMMY
    \def\@listtail{}
  \else
    % Удаляем лишнюю запятую из конца списка.
    \expandafter\@@spliceList #2\DUMMY
  \fi
}
% Удаляем лишнюю запятую из конца списка.
\def\@@spliceList#1,\DUMMY{\def\@listtail{#1}}

% Собственная команда для загрузки пакетов, проверяющая,
% не были ли они загружены ранее.
% Это нужно для предотвращения ситуации несовпадения использованных опций пакета.
\@ifpackageloaded{xparse}{}{\RequirePackage{xparse}}

\NewDocumentCommand{\package@add}{omo}{%
  \@ifpackageloaded{#2}{}{%
    \IfValueTF{#1}{%
      \IfValueTF{#3}%
      {\RequirePackage[#1]{#2}[#3]}%
      {\RequirePackage[#1]{#2}}
    }{%
      \IfValueTF{#3}%
      {\RequirePackage{#2}[#3]}%
      {\RequirePackage{#2}}
    }
  }%
}

% ---------------------------------------------------------------------------- %
% Предварительные проверки                                                     %
% ---------------------------------------------------------------------------- %

% Данная преамбула не предназначена для работы с pdfLaTeX.
\package@add{iftex}
\ifpdftex
  \PackageError{praeambel}{pdftex is not supported}{Use XeTeX or LuaTeX instead}
  \@@end
\fi

% Проверка использования преамбулы в beamer.
\newif\ifpraeambel@beamer
\praeambel@beamerfalse
\@ifclassloaded{beamer}{\praeambel@beamertrue}{}

% Проверка использования преамбулы в book и extbook.
\newif\ifpraeambel@book
\praeambel@bookfalse
\@ifclassloaded{book}{\praeambel@booktrue}{}
\@ifclassloaded{extbook}{\praeambel@booktrue}{}

% Проверка использования преамбулы в article и extarticle.
\newif\ifpraeambel@article
\praeambel@articlefalse
\@ifclassloaded{article}{\praeambel@articletrue}{}
\@ifclassloaded{extarticle}{\praeambel@articletrue}{}

% ---------------------------------------------------------------------------- %
% Параметры пакета                                                             %
% ---------------------------------------------------------------------------- %

\package@add{kvoptions}

% Опция для использования babel вместо polyglossia.
\DeclareBoolOption{babel}

% Опция для включения пакетов для создания графиков.
\DeclareBoolOption{plots}

% Опция для включения пакетов для фиксации изменений.
\DeclareBoolOption{changes}

% Опция для указания, что преамбула будет работать в LyX.
%\DeclareBoolOption{lyx}

% Список языков.
% Если опция не указана, то используется русский язык.
\DeclareStringOption[russian]{language}

% Опции для выбора основных шрифтов:
% - Основного,
\DeclareStringOption[PT Astra Serif]{mainfont}
% - Без засечек,
\DeclareStringOption[PT Astra Sans]{sansfont}
% - Моноширинного,
\DeclareStringOption[Cascadia Code]{monofont}
% - Математического.
\DeclareStringOption[Libertinus Math]{mathfont}

% Обрабатываем опции.
\ProcessKeyvalOptions*

% ---------------------------------------------------------------------------- %
% Языковые настройки и шрифты                                                  %
% ---------------------------------------------------------------------------- %

% Пакет для работы с системными шрифтами
\package@add{fontspec}

% Основные языковые пакеты: babel или polyglossia.
\ifpraeambel@babel
  \package@add[\praeambel@language]{babel}
\else
  % Обработка списка языков.
  \package@add{polyglossia}
  \spliceList{\praeambel@language}
  \setdefaultlanguage{\@listhead}
  \ifx\@listtail\empty
  \else
    \setotherlanguages{\@listtail}
  \fi
\fi

% Стандартные опции для шрифтов.
\defaultfontfeatures{Ligatures={TeX},Scale=MatchLowercase}
\defaultfontfeatures[\rmfamily]{Ligatures={TeX},Scale=1}

% Назначаем все шрифты.
\setmainfont{\praeambel@mainfont}
\setsansfont{\praeambel@sansfont}
\setmonofont{\praeambel@monofont}

% В цикле перебираем все языки и задаем соответствующие семейства.
% Детальнее в разделе 2.1 справки к пакету fontspec.
\@for\@lang:=\praeambel@language\do{%
  \expandafter\newfontfamily\csname\@lang font\endcsname{\praeambel@mainfont}
  \expandafter\newfontfamily\csname\@lang fontsf\endcsname{\praeambel@sansfont}
  \expandafter\newfontfamily\csname\@lang fonttt\endcsname{\praeambel@monofont}
}

% Прочие шрифтовые пакеты
\package@add{cmap}
\package@add{csquotes}
\package@add{moresize}

% ------------------------------- %
% Математические шрифты и символы %
% ------------------------------- %

\package@add{amsmath}
\package@add{amssymb}

\ifpraeambel@beamer
\else
  % В beamer уже есть свои окружения для теорем
  \package@add{amsthm}
  \package@add{nicefrac}

  \theoremstyle{definition}
  \newtheorem*{theorem}{Теорема}
  \newtheorem{example}{Пример}
\fi

% mathtools что-то делает с горизонтальными фигурными скобками (ломает)
% https://tex.stackexchange.com/q/552864/283103
\let\normalunderbrace=\underbrace
\package@add{mathtools}
\package@add{unicode-math}
\let\underbrace=\normalunderbrace

% Устанавливаем математический шрифт.
\setmathfont{\praeambel@mathfont}

% ---------------------------------------------------------------------------- %
% Геометрия страницы                                                           %
% ---------------------------------------------------------------------------- %

\ifpraeambel@beamer
\else
  \package@add[left=3cm, right=1.5cm, top=2cm, bottom=2cm]{geometry}
\fi

% ---------------------------------------------------------------------------- %
% Размещение текста: красная строка, штрафы                                    %
% ---------------------------------------------------------------------------- %

\package@add{parskip}
\ifpraeambel@beamer
\else
  % Полуторный интервал.
  \package@add{setspace}
  \onehalfspacing
  \setdisplayskipstretch{}

  % Настройка красной строки.
  \package@add{indentfirst}
  \setlength{\parindent}{12.5mm}
  \righthyphenmin=2

  \widowpenalty=10000
  \tolerance=1000
\fi

% ---------------------------------------------------------------------------- %
% Титульная страница                                                           %
% ---------------------------------------------------------------------------- %

\ifpraeambel@beamer
  % Команда для слайда с заголовком.
  \newcommand\makebeamertitle{\frame{\maketitle}}
\else
  % Подзаголовок на титульном листе.
  \package@add{etoolbox}
  \providecommand{\subtitle}[1]{
    \apptocmd{\@title}{\par {\large #1 \par}}{}{}
  }
\fi

% Более компактный заголовок статьи.
\ifpraeambel@article
  \def\@maketitle{%
    \newpage
    \null
    \begin{center}%
      \let \footnote \thanks
      {\Large \@title \par}%
      \ifx\@author\empty
      \else
      {\large
        \lineskip .5em%
        \begin{tabular}[t]{c}%
          \@author
        \end{tabular}\par}%
      \fi%
      {\large \@date}%
    \end{center}%
    \par}
\fi

% ---------------------------------------------------------------------------- %
% Заголовки глав и разделов в книгах                                           %
% ---------------------------------------------------------------------------- %

\ifpraeambel@book
  \package@add[compact]{titlesec}
  \package@add{titletoc}

  \titlecontents{part}[0pt]{\bfseries}{\partname\ \thecontentslabel:\quad}{}{\hfill\contentspage}
  \titlecontents{chapter}[0pt]{\bfseries}{\chaptername\ \thecontentslabel:\quad}{}{\hfill\contentspage}

  \gdef\thepart{\Roman{part}}

  \titleformat{\chapter}[display]{\normalfont\Large\bfseries}{\chaptername~\thechapter}{0pt}{}
  \titlespacing{\chapter}{0pt}{\parskip}{\parskip}

  \titleformat{\section}{\normalfont\Large\bfseries}{\thesection}{1em}{}
  \titlespacing{\section}{0pt}{\parskip}{\parskip}

  \titleformat{\subsection}{\normalfont\large\bfseries}{\thesubsection}{1em}{}
  \titlespacing{\subsection}{0pt}{\parskip}{\parskip}

  \AddToHook{cmd/appendix/after}{%
    \gdef\@chapapp{\appendixname}%
    \gdef\chaptername{\appendixname}%
    \gdef\thechapter{\Asbuk{chapter}}%
    \titleformat{\chapter}{\normalfont\Large\bfseries}{\thechapter}{1em}{}}
\fi

\ifpraeambel@article
  \AddToHook{cmd/appendix/after}{\gdef\thesection{\Asbuk{section}}}
\fi

% ---------------------------------------------------------------------------- %
% Ссылки и закладки                                                            %
% ---------------------------------------------------------------------------- %

\package@add{bookmark}

\package@add[
  backend=biber,
  bibstyle=gost-authoryear-min,
  citestyle=gost-authoryear,
  movenames=false
]{biblatex}

% Установка штрафов для biblatex, поскольку этот пакет сам обрабатывает ссылки.
\setcounter{biburllcpenalty}{100}
\setcounter{biburlucpenalty}{200}
\setcounter{biburlnumpenalty}{100}

% Этот пакет позволяет автоматически разбивать длинные ссылки
% в произвольном месте.
\PassOptionsToPackage{hyphens}{url}
\package@add{xurl}
\urlstyle{same}

\ifpraeambel@beamer
  % Нумерация заголовков в приложениях в beamer.
  \package@add{appendixnumberbeamer}
\fi

% ---------------------------------------------------------------------------- %
% Списки                                                                       %
% ---------------------------------------------------------------------------- %

\ifpraeambel@beamer
\else
  % enumitem конфликтует с beamer, поэтому совместно их не используем.
  % Вообще, говорят, что это можно обойти, но зачем...
  \package@add[inline]{enumitem}
  \AddEnumerateCounter{\Asbuk}{\russian@alph}{Щ}
  \AddEnumerateCounter{\asbuk}{\russian@alph}{щ}
\fi

% Команда для локального сжатия списков.
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}%
  \setlength{\parskip}{0pt}
}

% ---------------------------------------------------------------------------- %
% Подписи плавающих объектов                                                   %
% ---------------------------------------------------------------------------- %

\package@add{caption}

% Данный пакет добавляет возможность создавать вложенные объекты с подписями.
\package@add{subcaption}

% ---------------------------------------------------------------------------- %
% Таблицы                                                                      %
% ---------------------------------------------------------------------------- %

\ifpraeambel@beamer
\else
  % longtable не очень хорошо работает в beamer.
  \package@add{longtable}
\fi

% Красивые горизонтальные линии.
\package@add{booktabs}

% Ячейки на несколько строк и столбцов.
\package@add{multicol}
\package@add{multirow}

% Пакет для создания ячеек с переносами строк.
\package@add{makecell}

% Пакет для раскрашивания столбцов, строк, ячеек и линий.
\package@add{colortbl}

% Работа с единицами измерения.
\package@add{siunitx}[=v2]
\sisetup{
  detect-all,
  table-number-alignment=center,
  table-figures-integer=2,
  table-figures-decimal=2
}

% ---------------------------------------------------------------------------- %
% Рисунки и графики                                                            %
% ---------------------------------------------------------------------------- %

\package@add{graphicx}

\ifpraeambel@plots
  \package@add{tikz}
  \package@add{pgfplots}
  \package@add{pgfplotstable}
  \pgfplotsset{compat=1.18}
\fi

% ---------------------------------------------------------------------------- %
% Листинги                                                                     %
% ---------------------------------------------------------------------------- %

\package@add{minted}
\package@add{fancyvrb}

% ---------------------------------------------------------------------------- %
% Прочее                                                                       %
% ---------------------------------------------------------------------------- %

% Пакеты для фиксации изменений
\ifpraeambel@changes
  \package@add{cancel}
  \package@add[commandnameprefix=always]{changes}
  \newcommand{\stkout}[1]{\ifmmode\xcancel{#1}\else\sout{#1}\fi}
  \setdeletedmarkup{\stkout{#1}}
\fi

% Пакет для работы с цветами.
\package@add{xcolor}

% Пакет для микротипографики.
% В XeTeX работает не до конца, в LuaTeX все отлично,
% что неудивительно, если учесть, что послений является официально признанным
% преемником pdfLaTeX!
\package@add{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts

% Разные коробочки.
\package@add{adjustbox}
\package@add[most]{tcolorbox}

% ------------------------- %
% Передаем опции в hyperref %
% ------------------------- %
\PassOptionsToPackage{unicode}{hyperref}

\endinput
